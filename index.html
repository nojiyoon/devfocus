<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevFocus: Flow State (Refined Audio)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root { 
            --bg: #0d1117; 
            --text: #c9d1d9; 
            --dim: #8b949e; 
            --accent: #58a6ff;
            --log-source: #79c0ff;
            --log-note: #d2a8ff;   
            --btn-border: #30363d;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: var(--bg); font-family: 'Fira Code', 'Consolas', monospace; overflow: hidden; color: var(--text); }
        
        #app { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; position: relative; z-index: 10; gap: 40px; }
        
        /* --- Timer Input Style --- */
        .timer-container { position: relative; display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        
        #timer-input {
            font-size: 6rem; font-weight: 700; color: var(--text);
            background: transparent; border: none; outline: none;
            text-align: center; width: 450px; font-family: inherit;
            border-bottom: 2px solid transparent; transition: border-color 0.3s;
            cursor: text;
        }
        #timer-input:focus { border-bottom: 2px solid var(--accent); }
        
        /* --- Button Group --- */
        .controls { display: flex; gap: 20px; z-index: 20; }
        
        button {
            background: transparent; border: 1px solid var(--btn-border); color: var(--accent);
            padding: 15px 30px; font-size: 1rem; cursor: pointer; transition: all 0.2s ease;
            font-family: inherit; border-radius: 6px; text-transform: uppercase; letter-spacing: 1.5px;
            min-width: 160px; background: rgba(13, 17, 23, 0.8);
        }
        button:hover { border-color: var(--accent); background: rgba(88, 166, 255, 0.1); }
        button:active { transform: translateY(1px); }
        
        button.primary-active { background: var(--accent); color: var(--bg); border-color: var(--accent); font-weight: bold; }
        button.primary-active:hover { background: #79c0ff; border-color: #79c0ff; }

        /* --- Terminal Log Stack --- */
        #log-container {
            position: absolute; bottom: 30px; left: 30px;
            width: 500px; height: 250px;
            overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end;
            pointer-events: none; opacity: 0; transition: opacity 1s; 
            font-size: 0.85rem; line-height: 1.6;
            mask-image: linear-gradient(to bottom, transparent, black 20%);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%);
        }
        .log-entry { 
            color: var(--dim); white-space: nowrap; 
            animation: slideUp 0.3s ease-out forwards; 
        }
        .log-ts { opacity: 0.5; margin-right: 10px; font-size: 0.8rem; }
        .log-src { color: var(--log-source); font-weight: bold; margin-right: 5px; }
        .log-note { color: var(--log-note); }

        /* --- Visual Feedback --- */
        #halo {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 1px; height: 1px; border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(88, 166, 255, 0.1); transition: box-shadow 0.1s; z-index: 0;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 0.8; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="halo"></div>
    
    <div id="app">
        <div class="timer-container">
            <input type="text" id="timer-input" value="25:00" spellcheck="false">
        </div>

        <div class="controls">
            <button id="toggle-btn">START FOCUS</button>
            <button id="reset-btn">RESET</button>
        </div>
    </div>

    <div id="log-container"></div>

    <script>
        // --- System State ---
        const STATE = {
            isPlaying: false,
            timerInterval: null,
            timeLeft: 25 * 60,
            originalTime: 25 * 60
        };

        const timerInput = document.getElementById('timer-input');
        const toggleBtn = document.getElementById('toggle-btn');
        const resetBtn = document.getElementById('reset-btn');
        const logContainer = document.getElementById('log-container');
        const halo = document.getElementById('halo');

        // --- Audio Engine (Refined) ---
        let padSynth, modularSynth, noise, lowPassFilter, highPassFilter, reverb, delay, limiter;

        async function initAudio() {
            await Tone.start();
            
            // [Fix 3] Master Limiter: 소리가 커졌을 때 찢어지는 현상 방지
            limiter = new Tone.Limiter(-2).toDestination();

            // [Fix 1] Rumble Filter: 웅웅거리는 초저역대(100Hz 이하)를 잘라냄
            highPassFilter = new Tone.Filter(100, "highpass").connect(limiter);

            // Mood Filter: 전체적으로 부드러운 느낌을 위한 로우패스
            lowPassFilter = new Tone.Filter(2000, "lowpass").connect(highPassFilter);

            // [Fix 2] Reverb Taming: Decay 12초 -> 8초, Wet 0.5 -> 0.3 (울림 감소)
            reverb = new Tone.Reverb({ decay: 8, preDelay: 0.1, wet: 0.3 }).connect(lowPassFilter);
            
            // Delay: 피드백을 줄여서 소리가 덜 겹치게 함
            delay = new Tone.PingPongDelay({ delayTime: "8n.", feedback: 0.15, wet: 0.25 }).connect(reverb);

            // Instruments
            padSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" }, // 순수한 사인파로 변경하여 거친 느낌 제거
                envelope: { attack: 2, decay: 3, sustain: 0.5, release: 4 }
            }).connect(delay);
            padSynth.volume.value = -14; // 볼륨 약간 하향

            modularSynth = new Tone.PolySynth(Tone.FMSynth, {
                harmonicity: 3, modulationIndex: 3, // 변조 지수를 낮춰서 덜 자극적이게
                envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.3 }
            }).connect(reverb);
            modularSynth.volume.value = -20;

            // [Fix 1 Related] Noise Adjustment
            noise = new Tone.Noise("pink").connect(lowPassFilter);
            // 볼륨을 대폭 낮춤 (-48 -> -58) 배경 질감만 남김
            noise.volume.value = -58; 
            noise.start();

            // Sequencer
            const scale = ["C3", "E3", "G3", "B3", "D4", "F#4", "A4"]; 
            const loopIds = ["LOOP_ALPHA", "LOOP_BETA", "LOOP_GAMMA", "LOOP_DELTA"];

            // Pad Layer
            new Tone.Loop(time => {
                if (Math.random() < 0.6) {
                    const note = scale[Math.floor(Math.random() * scale.length)];
                    padSynth.triggerAttackRelease(note, "1n", time);
                    
                    Tone.Draw.schedule(() => {
                        addLog("LOOP_PAD", note, 0.5);
                        pulseHalo(false);
                    }, time);
                }
            }, "7n").start(0);

            // Modular Layer
            new Tone.Loop(time => {
                if (Math.random() < 0.4) {
                    const rawNote = scale[Math.floor(Math.random() * scale.length)];
                    const octaveNote = Tone.Frequency(rawNote).transpose(12);
                    
                    modularSynth.triggerAttackRelease(octaveNote, "32n", time);
                    
                    Tone.Draw.schedule(() => {
                        const noteName = octaveNote.toNote();
                        const loopName = loopIds[Math.floor(Math.random() * loopIds.length)];
                        addLog(loopName, noteName, 0.4 + Math.random() * 0.2);
                        pulseHalo(true);
                    }, time);
                }
            }, "8n").start(0);
        }

        // --- Timer Logic ---
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function parseTimeInput(str) {
            const parts = str.split(':');
            if (parts.length === 1) return parseInt(parts[0]) * 60;
            if (parts.length === 2) return parseInt(parts[0]) * 60 + parseInt(parts[1]);
            return 25 * 60; 
        }

        function startTimer() {
            if (!STATE.isPlaying && STATE.timeLeft === STATE.originalTime) {
                const val = parseTimeInput(timerInput.value);
                if (!isNaN(val) && val > 0) {
                    STATE.originalTime = val;
                    STATE.timeLeft = val;
                }
            }

            STATE.timerInterval = setInterval(() => {
                STATE.timeLeft--;
                timerInput.value = formatTime(STATE.timeLeft);
                if (STATE.timeLeft <= 0) finishSession();
            }, 1000);

            toggleBtn.innerText = "PAUSE"; 
            toggleBtn.classList.add('primary-active');
            timerInput.readOnly = true;
            logContainer.style.opacity = 1; 
            
            STATE.isPlaying = true;
            
            if(!padSynth) initAudio().then(() => Tone.Transport.start());
            else Tone.Transport.start();

            addLog("SYSTEM", "Focus_Session_Started", 1.0);
        }

        function pauseTimer() {
            clearInterval(STATE.timerInterval);
            Tone.Transport.pause();
            if(padSynth) padSynth.releaseAll();

            toggleBtn.innerText = "RESUME FOCUS";
            toggleBtn.classList.remove('primary-active');
            timerInput.readOnly = false;
            logContainer.style.opacity = 0.3; 
            
            STATE.isPlaying = false;
            addLog("SYSTEM", "Session_Paused", 0.0);
        }

        function resetTimer() {
            pauseTimer();
            STATE.timeLeft = STATE.originalTime;
            timerInput.value = formatTime(STATE.originalTime);
            toggleBtn.innerText = "START FOCUS";
            Tone.Transport.stop();
            logContainer.innerHTML = ""; 
            addLog("SYSTEM", "Timer_Reset", 0.0);
        }

        function finishSession() {
            pauseTimer();
            toggleBtn.innerText = "START FOCUS";
            timerInput.readOnly = false;
            STATE.timeLeft = STATE.originalTime;
            timerInput.value = formatTime(STATE.originalTime);

            const synth = new Tone.Synth({
                oscillator: { type: "triangle" }, 
                envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 }
            }).toDestination();

            const now = Tone.now();
            synth.volume.value = -10;
            synth.triggerAttackRelease("C5", "16n", now);
            synth.triggerAttackRelease("E5", "16n", now + 0.1);
            synth.triggerAttackRelease("G5", "16n", now + 0.2);
            synth.triggerAttackRelease("C6", "8n",  now + 0.3);
            
            addLog("SYSTEM", "Session_Complete", 1.0);
        }

        function addLog(source, note, vol) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            
            const now = new Date();
            const ts = `[${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}.${String(now.getMilliseconds()).padStart(3,'0')}]`;
            
            div.innerHTML = `<span class="log-ts">${ts}</span> <span class="log-src">${source}</span> :: emit(<span class="log-note">${note}</span>) vol:${vol.toFixed(2)}`;
            
            logContainer.appendChild(div);
            
            if (logContainer.children.length > 12) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        function pulseHalo(isStrong) {
            const size = isStrong ? "100px" : "50px";
            const opacity = isStrong ? "0.15" : "0.05";
            halo.style.boxShadow = `0 0 ${size} ${size} rgba(88, 166, 255, ${opacity})`;
            setTimeout(() => { halo.style.boxShadow = `0 0 0 0 rgba(88, 166, 255, 0)`; }, 1000);
        }

        toggleBtn.addEventListener('click', () => STATE.isPlaying ? pauseTimer() : startTimer());
        resetBtn.addEventListener('click', resetTimer);
        timerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                timerInput.blur();
                if (!STATE.isPlaying) startTimer();
            }
        });
    </script>
</body>
</html>
